<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapeamento de Cobertura 2.0 - E-MÍDIAS</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Estilos do projeto -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- CABEÇALHO SUPERIOR COM LOGO -->
    <div class="top-header">
        <img src="https://raw.githubusercontent.com/kaike74/distribuicaoemidias/main/logo%20E-MIDIAS%20png%20fundo%20escuro%20HORIZONTAL%20(1).png" 
             alt="E-MÍDIAS Logo" 
             class="top-logo"
             onerror="this.style.display='none'">
    </div>

  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <div class="header-content">
        <div class="header-main">
          <h1 class="header-title" id="radio-name">
            Carregando...
            <img class="header-logo" id="header-logo" src="" alt="Logo" style="display: none;">
          </h1>
          <div class="header-subtitle">
            <span id="radio-info">Mapeamento de Cobertura 2.0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- LOADING -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>Carregando dados e processando arquivos KMZ/KML...</p>
    </div>

    <!-- ERROR -->
    <div id="error" class="error" style="display: none;">
      <div id="error-message"></div>
      <div id="error-details" class="error-details" style="display: none;"></div>
    </div>

    <!-- CARDS DE INFORMAÇÕES -->
    <div id="info-section" class="info-grid" style="display: none;">
      <!-- Card 1: Informações Básicas -->
      <div class="info-card">
        <h3 class="card-title">📻 Informações da Rádio</h3>
        <div class="info-item">
          <span class="info-label">Dial:</span>
          <span class="info-value" id="info-dial">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">UF:</span>
          <span class="info-value" id="info-uf">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Praça:</span>
          <span class="info-value" id="info-praca">-</span>
        </div>
      </div>

      <!-- Card 2: Cobertura -->
      <div class="info-card">
        <h3 class="card-title">🌍 Cobertura</h3>
        <div class="info-item">
          <span class="info-label">População total:</span>
          <span class="info-value" id="info-pop-total">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Universo:</span>
          <span class="info-value" id="info-pop-coberta">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Cidades:</span>
          <span class="info-value" id="info-cidades-count">-</span>
        </div>
      </div>
    </div>

    <!-- MAPA -->
    <div id="map-section" class="map-container" style="display: none;">
        <div class="map-layout">
            <div class="map-content" id="map-content">
                <div id="map"></div>
                
                <!-- LEGENDA DE CORES -->
                <div class="map-legend" id="map-legend" style="display: none;">
                    <h4>Legenda de Sinal</h4>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #00FF00;"></span>
                        <span>Excelente</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #00FFFF;"></span>
                        <span>Ótimo</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #0000FF;"></span>
                        <span>Fraco</span>
                    </div>
                </div>
                
                <!-- 🆕 PAINEL DE CONTROLE DE RÁDIOS (MODO PROPOSTA) -->
                <div class="radios-control-panel" id="radios-control-panel" style="display: none;">
                    <div class="panel-header">
                        <h4>📻 Controle de Rádios</h4>
                        <button class="panel-toggle" onclick="toggleRadiosPanel()">📐</button>
                    </div>
                    <div class="panel-content" id="radios-panel-content">
                        <div class="panel-actions">
                            <button class="panel-btn" onclick="showAllCoverages()">🌍 Mostrar Todas</button>
                            <button class="panel-btn" onclick="hideAllCoverages()">👁️ Ocultar Todas</button>
                        </div>
                        <div class="radios-list-panel" id="radios-list-panel">
                            <!-- Lista de rádios será preenchida dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CIDADES OU RÁDIOS -->
    <div id="cidades-section" class="cidades-container" style="display: none;">
      <div class="cidades-header">
        <h2 class="cidades-title">
          🏙️ Cidades de Cobertura
          <span class="cidade-count" id="cidade-count">0</span>
        </h2>
        <div class="cidades-actions">
          <button class="excel-export-btn" onclick="exportToExcel()" title="Exportar cidades para Excel">
            📊 Exportar Excel (.xlsx)
          </button>
        </div>
      </div>
      <div class="search-box">
        <input type="text" class="search-input" id="city-search" placeholder="🔍 Buscar cidade, estado ou qualidade de sinal...">
      </div>
      <div class="cidades-list" id="cidades-list"></div>
    </div>

    <!-- 🆕 ESTATÍSTICAS CONSOLIDADAS (MODO PROPOSTA) -->
    <div id="stats-section" class="stats-container" style="display: none;">
      <div class="stats-header">
        <h2 class="stats-title">
          📊 Estatísticas Consolidadas
        </h2>
      </div>
      <div class="stats-grid" id="stats-grid">
        <!-- Estatísticas serão preenchidas dinamicamente -->
      </div>
    </div>

    <!-- RODAPÉ -->
    <div class="footer">
      <p class="footer-text">Plataforma de Mapeamento de Cobertura 2.0 • E-MÍDIAS</p>
      <p class="footer-mode" id="footer-mode"></p>
    </div>
  </div>

  <!-- Bibliotecas externas -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Script do projeto -->
  <script src="script.js"></script>

  <!-- 🆕 SCRIPT ADICIONAL PARA CONTROLES DA PROPOSTA -->
  <script>
    // =========================================================================
    // 🎛️ CONTROLES DO PAINEL DE RÁDIOS (MODO PROPOSTA)
    // =========================================================================
    
    function toggleRadiosPanel() {
      const panel = document.getElementById('radios-panel-content');
      const isVisible = panel.style.display !== 'none';
      panel.style.display = isVisible ? 'none' : 'block';
    }
    
    function showAllCoverages() {
      if (typeof radiosLayers !== 'undefined') {
        Object.values(radiosLayers).forEach(layer => {
          if (map.hasLayer(layer)) {
            layer.setOpacity(0.6);
          } else {
            layer.addTo(map);
            layer.setOpacity(0.6);
          }
        });
        console.log('✅ Todas as coberturas mostradas');
      }
    }
    
    function hideAllCoverages() {
      if (typeof radiosLayers !== 'undefined') {
        Object.values(radiosLayers).forEach(layer => {
          if (map.hasLayer(layer)) {
            map.removeLayer(layer);
          }
        });
        console.log('👁️ Todas as coberturas ocultadas');
      }
    }
    
    function toggleRadioCoverage(radioId) {
      if (typeof radiosLayers !== 'undefined' && radiosLayers[radioId]) {
        const layer = radiosLayers[radioId];
        const checkbox = document.getElementById(`radio-${radioId}`);
        
        if (map.hasLayer(layer)) {
          map.removeLayer(layer);
          checkbox.checked = false;
          console.log(`👁️ Cobertura de ${radioId} ocultada`);
        } else {
          layer.addTo(map);
          checkbox.checked = true;
          console.log(`✅ Cobertura de ${radioId} mostrada`);
        }
      }
    }
    
    function focusOnRadio(radioId) {
      if (typeof propostaData !== 'undefined') {
        const radio = propostaData.radios.find(r => r.id === radioId);
        if (radio && radio.antennaLocation) {
          map.flyTo([radio.antennaLocation.lat, radio.antennaLocation.lng], 10, {
            animate: true,
            duration: 1.5
          });
          
          // Destacar cobertura temporariamente
          if (radiosLayers[radioId]) {
            const layer = radiosLayers[radioId];
            const originalOpacity = layer.options.opacity || 0.6;
            layer.setOpacity(0.9);
            setTimeout(() => layer.setOpacity(originalOpacity), 2000);
          }
        }
      }
    }
    
    // =========================================================================
    // 🔄 DETECTAR MODO E CONFIGURAR INTERFACE
    // =========================================================================
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const isPropostaMode = params.has('idproposta');
      
      // Atualizar rodapé com modo atual
      const footerMode = document.getElementById('footer-mode');
      if (footerMode) {
        footerMode.textContent = isPropostaMode ? 
          '🌟 Modo Proposta - Múltiplas Rádios' : 
          '📻 Modo Individual - Rádio Única';
      }
      
      // Configurar interface baseada no modo
      if (isPropostaMode) {
        // Mostrar painel de controle de rádios
        setTimeout(() => {
          const panel = document.getElementById('radios-control-panel');
          if (panel) {
            panel.style.display = 'block';
          }
        }, 3000);
      }
    });
  </script>
</body>
</html>
